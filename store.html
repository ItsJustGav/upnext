<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UpNext — Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0a0c10; --card: #11141a; --card2: #0f1116; --border: #1a1f2a;
      --text: #f5faff; --muted: #9bb1c9; --primary: #00eaff; --focus: rgba(0,234,255,.35); --ok: #00b4ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(circle at 50% 0%, #0e1720, #07080b 90%);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,sans-serif}
    a{color:#b7f8ff;text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,#0a0c10 0%,#0b1323 100%);
      border-bottom:1px solid var(--border);box-shadow:0 0 12px rgba(0,234,255,.15);
      padding:14px 18px;display:flex;align-items:center;gap:12px}
    .brand{font-weight:900;letter-spacing:.2px;font-size:1.3rem;text-shadow:0 0 10px rgba(0,234,255,.5)}
    .tight{letter-spacing:-.5px}
    .brand-next{color:var(--primary);font-weight:900;text-shadow:0 0 8px rgba(0,234,255,.8)}
    .pill{background:#11141a;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    main{max-width:1100px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 0 14px rgba(0,234,255,.06)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,button,select{border-radius:10px;border:1px solid var(--border);background:#10141c;color:var(--text);padding:10px 12px;font-size:14px}
    button{background:var(--primary);border-color:var(--primary);color:#000;font-weight:700;cursor:pointer;box-shadow:0 0 12px rgba(0,234,255,.3);transition:transform .15s, box-shadow .15s}
    button:hover{transform:translateY(-1px);box-shadow:0 0 18px rgba(0,234,255,.5)}
    button.secondary{background:#0e121a;border-color:#1b2738;color:#c6deff;box-shadow:none}
    button.danger{background:#1c0f12;border-color:#52222a;color:#ff9ba6}
    button.ok{background:var(--ok);border-color:var(--primary);color:#000;box-shadow:0 0 10px rgba(0,234,255,.4)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    tr:nth-child(even){background:var(--card2)}
    th{color:#c3eaff;font-weight:700}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);display:inline-block}
    .tag.red{background:#1a0f16;border-color:#d42a5e;color:#ff8fb3}
    .tag.grey{background:#081820;border-color:#00eaff;color:#b7f8ff;box-shadow:0 0 8px rgba(0,234,255,.4)}
    .tag.yellow{background:#1a1610;border-color:#caa52e;color:#ffe9a3}
    .muted{color:var(--muted);font-size:12px}
    .longhint{color:#9bb1c9;font-size:12px;margin-top:6px}
    footer{margin:16px 0;color:#7ab5ff;font-size:12px;text-align:center;text-shadow:0 0 10px rgba(0,234,255,.4)}
  </style>
</head>
<body>
  <header>
    <a href="index.html">← Stores</a>
    <div class="brand">U<span class="tight">p</span><span class="brand-next">Next</span></div>
    <div id="storeTitle" class="pill"></div>
    <span class="pill" id="stats"></span>
    <span class="pill" id="meBadge" style="margin-left:auto;"></span>
  </header>

  <main>
    <div class="card">
      <h2 style="margin:0 0 8px">Shift</h2>
      <div class="row">
        <input id="myName" placeholder="Your name" />
        <button id="startShiftBtn">Start Shift</button>
        <button id="rememberMeBtn" class="secondary">Remember Me</button>
      </div>
      <div class="muted" style="margin-top:6px">
        Starting adds you to rotation. “Up Next” is anyone who hasn’t had a customer yet.
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Rotation</h2>
      <table>
        <thead>
          <tr><th>Rep</th><th>Status</th><th>Actions</th><th>Updated</th></tr>
        </thead>
        <tbody id="repTable"></tbody>
      </table>
      <div class="muted" id="hint"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Queue Controls</h2>
      <div class="row">
        <button id="nextBtn">Next Turn</button>
        <button id="resetBtn" class="danger" title="Hold to reset (1.5s)">Reset Store</button>
      </div>
      <div class="longhint">Hold for 1.5s to reset.</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Recent Activity</h2>
      <div id="history" class="muted">No activity yet.</div>
    </div>

    <footer>
      Who’s <b>Up<span style="color:#00eaff;">Next</span></b>? Check before you guess.
    </footer>
  </main>

  <script>
    const params = new URLSearchParams(location.search);
    const storeCode = params.get("code") || "STORE";
    const storeName = params.get("name") || storeCode;
    document.getElementById("storeTitle").textContent = `${storeName} (${storeCode})`;

    const KEY  = `upnext:${storeCode}:reps`;
    const HKEY = `upnext:${storeCode}:history`;
    const MEKEY= `upnext:me`;
    const PKEY = "upnext:pin";
    const getPIN = () => localStorage.getItem(PKEY) || "";
    function requirePIN(){ const pin=getPIN(); if(!pin) return true; return prompt("Enter Manager PIN to continue:")===pin; }

    let reps = JSON.parse(localStorage.getItem(KEY) || "[]");
    let history = JSON.parse(localStorage.getItem(HKEY) || "[]");
    let remembered = localStorage.getItem(MEKEY) || "";

    const $ = id => document.getElementById(id);
    const nowISO = () => new Date().toISOString();

    function persist(){ localStorage.setItem(KEY, JSON.stringify(reps)); localStorage.setItem(HKEY, JSON.stringify(history)); render(); }
    function log(msg){ history.unshift(`[${new Date().toLocaleTimeString()}] ${msg}`); history = history.slice(0,50); }

    function ensureDefaults(r){
      if (r.hadFirst === undefined) r.hadFirst = (r.status === 'with_customer'); // assume true if already serving
      if (r.status === 'free' && !r.freeSince) r.freeSince = nowISO();
      if (r.status !== 'free') r.freeSince = r.freeSince || null;
      if (r.inQueue === undefined) r.inQueue = true;
    }
    reps.forEach(ensureDefaults);

    function addRep(name){
      name = name.trim(); if(!name) return;
      const ex = reps.find(r => r.name.toLowerCase() === name.toLowerCase());
      if (ex){
        ensureDefaults(ex);
        ex.inQueue = true;
        ex.status = 'free';
        ex.freeSince = nowISO();
        // do NOT flip hadFirst; their history stands
        ex.lastUpdate = nowISO();
        log(`${ex.name} started shift`);
      } else {
        const id = String(Date.now()) + Math.random();
        reps.push({ id, name, status:'free', inQueue:true, freeSince: nowISO(), hadFirst:false, lastUpdate: nowISO() });
        log(`${name} started shift`);
      }
      persist();
    }

    function setStatus(id, status){
      const r = reps.find(x => x.id === id); if(!r) return;
      r.status = status;
      if (status === 'with_customer') r.hadFirst = true; // first assignment marks as having had a customer
      if (status === 'free') r.freeSince = r.freeSince || nowISO();
      else r.freeSince = null;
      r.lastUpdate = nowISO();
      persist();
    }

    function clockOut(id){
      const idx = reps.findIndex(r => r.id === id);
      if (idx === -1) return;
      const name = reps[idx].name;
      reps.splice(idx, 1);
      log(`${name} clocked out (removed from queue)`);
      persist();
    }

    function freeSort(a,b){
      // unsold (hadFirst=false) first, then by freeSince ASC
      const pa = a.hadFirst ? 1 : 0;
      const pb = b.hadFirst ? 1 : 0;
      if (pa !== pb) return pa - pb;
      const ta = new Date(a.freeSince || '2100-01-01').getTime();
      const tb = new Date(b.freeSince || '2100-01-01').getTime();
      return ta - tb;
    }

    function nextTurn(){
      const candidates = reps.filter(r => r.inQueue && r.status==='free' && r.freeSince);
      if (!candidates.length) return alert("No eligible reps.");
      candidates.sort(freeSort);
      const winner = candidates[0];
      const idx = reps.findIndex(r => r.id === winner.id);
      const [r] = reps.splice(idx, 1);
      reps.unshift(r);
      r.status = 'with_customer';
      r.hadFirst = true;
      r.freeSince = null;
      r.lastUpdate = nowISO();
      log(`${r.name} is up (With Customer)`);
      persist();
    }

    function resetStore(){
      if (!requirePIN()) return;
      if (!confirm(`Reset ${storeName}?`)) return;
      reps = []; history = [];
      persist();
    }

    function render(){
      $("meBadge").textContent = remembered ? `You: ${remembered}` : "You: (not set)";
      if (remembered && !$("myName").value) $("myName").value = remembered;

      const free = reps.filter(r => r.inQueue && r.status==='free').sort(freeSort);
      const withC = reps.filter(r => r.inQueue && r.status==='with_customer');
      const away  = reps.filter(r => r.inQueue && r.status==='away');
      const display = [...free, ...withC, ...away];

      $("repTable").innerHTML = display.length ? display.map((r,i)=>{
        const tag = r.status==='with_customer' ? `<span class="tag red">With Customer</span>` :
                    r.status==='away'          ? `<span class="tag yellow">Away/Lunch</span>` :
                                                 `<span class="tag grey">${r.hadFirst ? 'Freed Up' : 'New / No Customer'}</span>`;
        const updated = new Date(r.lastUpdate).toLocaleTimeString();
        const upNext = (i===0 && r.status==='free') ? ` <span class="tag" style="border-color:#00eaff;">Up Next →</span>` : "";
        return `<tr>
          <td>${r.name}${upNext}</td>
          <td>${tag}</td>
          <td>
            <div class="row" style="gap:6px">
              <button class="secondary" onclick="setStatus('${r.id}','with_customer')">With Customer</button>
              <button class="secondary" onclick="setStatus('${r.id}','away')">Away</button>
              <button class="ok" onclick="setStatus('${r.id}','free')">Freed Up</button>
              <button class="danger" onclick="clockOut('${r.id}')">Clock Out</button>
            </div>
          </td>
          <td class="muted">${updated}</td>
        </tr>`;
      }).join("") : `<tr><td colspan="4" class="muted">No reps yet.</td></tr>`;

      const inQ = reps.length;
      const withCust = reps.filter(r => r.status==='with_customer').length;
      $("stats").textContent = `In queue: ${inQ} • With customers: ${withCust}`;

      const topFree = free[0];
      $("hint").textContent = topFree ? `Up Next: ${topFree.name} (${topFree.hadFirst ? 'had a customer' : 'no customer yet'})` : "";
      $("history").innerHTML = history.length ? history.slice(0,20).map(h=>`<div>${h}</div>`).join("") : "No activity yet.";
    }

    $("startShiftBtn").onclick = ()=>{
      const n = (document.getElementById("myName").value || "").trim() || (remembered || "").trim();
      if (!n) return alert("Enter your name first.");
      addRep(n);
    };
    $("rememberMeBtn").onclick = ()=>{
      const n = (document.getElementById("myName").value || "").trim();
      if(!n) return alert("Type your name first.");
      localStorage.setItem(MEKEY, n); remembered = n; render();
      alert(`Saved "${n}" on this device.`);
    };
    $("nextBtn").onclick = nextTurn;

    // long press reset
    (function setupLongPressReset(){
      const btn = document.getElementById("resetBtn"); let t=null; const hold=1500;
      function start(){ t=setTimeout(()=>resetStore(), hold); }
      function cancel(){ if(t) clearTimeout(t); }
      btn.addEventListener("mousedown",start);
      btn.addEventListener("touchstart",start);
      ["mouseup","mouseleave","mouseout","touchend","touchcancel"].forEach(ev=>btn.addEventListener(ev,cancel));
    })();

    render();
  </script>
</body>
</html>
